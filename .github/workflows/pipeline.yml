name: Deploy Multi-ambientes

on:
  workflow_dispatch:

jobs:
  # Job 1: Mostrar variáveis do repositório
  mostrar-variaveis-repositorio:
    runs-on: ubuntu-latest
    steps:
      - name: Exibir variáveis do repositório
        run: |
          echo "=== Variáveis do repositório ==="
          echo "Aplicação: ${{ vars.APP_NAME }}"
          echo "Região padrão: ${{ vars.DEFAULT_REGION }}"
          echo "Timeout padrão: ${{ vars.DEFAULT_TIMEOUT }}"
          echo "Versão do Node: ${{ vars.NODE_VERSION }}"

  # Job 2: Deploy em Desenvolvimento
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    needs: mostrar-variaveis-repositorio
    steps:
      - name: Configurar ambiente DEV
        run: |
          echo "=== DEPLOY EM DESENVOLVIMENTO ==="
          echo "Aplicação: ${{ vars.APP_NAME }}"
          echo "Ambiente: ${{ vars.ENVIRONMENT }}"
          echo "API URL: ${{ vars.API_URL }}"
          echo "Database: ${{ vars.DATABASE_NAME }}"
          echo "Região: ${{ vars.DEFAULT_REGION }}"
          echo "Debug Mode: ${{ vars.DEBUG_MODE }}"
          echo "Max Connections: ${{ vars.MAX_CONNECTIONS }}"

      - name: Simular build DEV
        run: |
          echo "Compilando aplicação para ${{ vars.ENVIRONMENT }}"
          echo "URL de destino: ${{ vars.API_URL }}"
          sleep 2
          echo "Build concluído em DEV"

  # Job 3: Deploy em Staging
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    needs: deploy-dev
    steps:
      - name: Configurar ambiente STAGING
        run: |
          echo "=== DEPLOY EM STAGING ==="
          echo "Aplicação: ${{ vars.APP_NAME }}"
          echo "Ambiente: ${{ vars.ENVIRONMENT }}"
          echo "API URL: ${{ vars.API_URL }}"
          echo "Database: ${{ vars.DATABASE_NAME }}"
          echo "Região: ${{ vars.DEFAULT_REGION }}"
          echo "Debug Mode: ${{ vars.DEBUG_MODE }}"
          echo "Max Connections: ${{ vars.MAX_CONNECTIONS }}"

      - name: Executar testes de integração
        run: |
          echo "Executando testes em ${{ vars.ENVIRONMENT }}"
          echo "Endpoint: ${{ vars.API_URL }}/health"
          sleep 2
          echo "Testes aprovados em STAGING"

  # Job 4: Deploy em Produção
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    needs: deploy-staging
    steps:
      - name: Configurar ambiente PRODUÇÃO
        run: |
          echo "=== DEPLOY EM PRODUÇÃO ==="
          echo "Aplicação: ${{ vars.APP_NAME }}"
          echo "Ambiente: ${{ vars.ENVIRONMENT }}"
          echo "API URL: ${{ vars.API_URL }}"
          echo "Database: ${{ vars.DATABASE_NAME }}"
          echo "Região: ${{ vars.DEFAULT_REGION }}"
          echo "Debug Mode: ${{ vars.DEBUG_MODE }}"
          echo "Max Connections: ${{ vars.MAX_CONNECTIONS }}"

      - name: Deploy em Produção
        run: |
          echo "Realizando deploy em ${{ vars.ENVIRONMENT }}"
          echo "URL pública: ${{ vars.API_URL }}"
          sleep 3
          echo "Deploy em PRODUÇÃO concluído com sucesso"

      - name: Notificar equipe
        run: |
          echo "Enviando notificação de deploy para ${{ vars.API_URL }}"
          echo "Versão implantada: ${{ vars.APP_NAME }} em ${{ vars.ENVIRONMENT }}"
